<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Permissions-Policy" content="ambient-light-sensor=(), speaker=(), vibrate=(), vr=()" />
  <title>CARTILLAS APP</title>
  <base target="_top" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
  />
  <?!= include('styles_menus'); ?>
</head>

<body>
  <div class="particles" id="particles"></div>
  <?!= include('header'); ?>

  <div class="main-container oculto" id="app-container">
    <aside class="sidebar">
      <div class="user-card">
        <div class="logo">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white" width="60px" height="60px">
            <path d="M0 0h24v24H0z" fill="none" />
            <path
              d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z" />
          </svg>
        </div>
        <h4 id="bienvenida">Cargando sesión...</h4>
        <h5 id="tuser">tipo de usuario</h5>
      </div>

      <ul class="nav-menu">
        <li class="nav-item oculto" id="menu-unidades">
          <a href="#" class="nav-link">
            <i class="fas fa-home"></i>
            <span>MIS UNIDADES</span>
          </a>
        </li>
        <li class="nav-item oculto" id="menu-dotacion">
          <a href="#" class="nav-link" onclick="mostrarPopup()">
            <i class="fas fa-id-card"></i>
            <span>DOTACIÓN</span>
          </a>
        </li>
        <li class="nav-item oculto" id="menu-redistr">
          <a href="#" class="nav-link">
            <i class="fas fa-search"></i>
            <span>REDISTRIBUCION</span>
          </a>
        </li>
        <li class="nav-item oculto" id="menu-informe-mov">
          <a href="#" class="nav-link">
            <i class="fas fa-chart-bar"></i>
            <span>INFORME CONTROL DE MOVIMIENTO</span>
          </a>
        </li>
        <li class="nav-item oculto" id="menu-informe-inv">
          <a href="#" class="nav-link">
            <i class="fas fa-cog"></i>
            <span>INFORME INVENTARIO</span>
          </a>
        </li>
      </ul>
    </aside>

    <main class="content">
      <div class="content-header">
        <h2 class="content-title">Panel del <span id="rol-dinamico"></span></h2>
        <div class="actions">
          <button class="btn btn-secondary" id="btn-actualizar">
            <i class="fas fa-sync-alt"></i> Actualizar
          </button>
        </div>
      </div>
      <div id="existencias" class="oculto">
        <?!= include('existencias');?>
      </div>
      <div id="traspaso-form" class="oculto">
        <?!= include('traspaso-form'); ?>
      </div>
      <div id="poblacion-form" class="oculto">
        <?!= include('poblacion'); ?>
      </div>
      <div id="admin-form" class="oculto">
        <?!= include('admin-form'); ?>
      </div>
    </main>
  </div>

  <div id="popup" class="glass-popup">
    <div class="glass-content">
      <span class="close-btn" onclick="cerrarPopup()">✖</span>
      <?!= include('traspaso-form'); ?>
    </div>
  </div>

  <div class="footer">
    Sistema de Cartillas de Salud © <span id="currentYear"></span>
  </div>

  <script>
    async function verificarSesion() {
      try {
        const response = await new Promise((resolve, reject) => {
          google.script.run
            .withSuccessHandler(resolve)
            .withFailureHandler(reject)
            .obtenerSesionCompleta();
        });

        if (!response || response.error || !response.sesion) {
          // No hay sesión activa, redirigir a login
          window.location.href = '?page=login';
          return;
        }

        // Hay sesión válida, mostrar UI
        actualizarInterfaz(response.sesion);
        document.getElementById('app-container').classList.remove('oculto');

        // Iniciar app
        initApp();

      } catch (error) {
        console.error('Error al verificar sesión:', error);
          window.location.href = '?page=login';
      }
    }

    function actualizarInterfaz(sesion) {
      document.getElementById("bienvenida").textContent = `Bienvenido/a, ${sesion.nombre || 'Usuario'}`;
      document.getElementById("tuser").textContent = sesion.t_usuario || "Tipo usuario";
      document.getElementById("rol-dinamico").textContent = sesion.t_usuario || "";
    }

    window.onload = verificarSesion;

    function initApp() {
      createParticles();
      setupEventListeners();
    }

    function createParticles() {
      const particlesContainer = document.getElementById('particles');
      const particleCount = 30;

      for (let i = 0; i < particleCount; i++) {
        const particle = document.createElement('div');
        particle.classList.add('particle');
        const size = Math.random() * 4 + 2;
        particle.style.width = `${size}px`;
        particle.style.height = `${size}px`;
        particle.style.left = `${Math.random() * 100}%`;
        particle.style.bottom = `-${size}px`;
        particle.style.animationDuration = `${Math.random() * 20 + 10}s`;
        particle.style.animationDelay = `${Math.random() * 10}s`;
        particle.style.opacity = Math.random() * 0.5 + 0.1;
        particlesContainer.appendChild(particle);
      }
    }

    function setupEventListeners() {
      document.querySelectorAll('input').forEach(input => {
        input.addEventListener('mouseenter', () => (input.style.transform = 'scale(1.02)'));
        input.addEventListener('mouseleave', () => (input.style.transform = 'scale(1)'));
      });

      const btnCerrarSesion = document.getElementById('btnCerrarSesion');
      if (btnCerrarSesion) {
        btnCerrarSesion.addEventListener('click', confirmarCerrarSesion);
      }

      const btnActualizar = document.getElementById('btn-actualizar');
      if (btnActualizar) {
        btnActualizar.addEventListener('click', () => location.reload());
      }

      const popup = document.getElementById('popup');
      if (popup) {
        popup.addEventListener('click', (e) => {
          if (e.target.id === 'popup') {
            cerrarPopup();
          }
        });
      }
    }
          function cerrarSesionFrontend() {
      google.script.run
        .withSuccessHandler(function (resultado) {
          if (resultado === true) {
          window.location.href = '?page=login';
          } else {
            alert("No se pudo cerrar sesión correctamente.");
          }
        })
        .cerrarSesion(); // Esta es tu función del lado servidor
    }

    function confirmarCerrarSesion() {
      if (confirm("¿Seguro que quieres cerrar sesión?")) {
        google.script.run
          .withSuccessHandler(() => {
          window.location.href = '?page=index';
          })
          .withFailureHandler(err => {
            alert("No se pudo cerrar sesión: " + err.message);
          })
          .cerrarSesion();
      }
    }

    function mostrarPopup() {
      document.getElementById('popup').style.display = 'flex';
    }

    function cerrarPopup() {
      document.getElementById('popup').style.display = 'none';
    }

    // Actualiza el año en el footer automáticamente
    document.getElementById('currentYear').textContent = new Date().getFullYear();
  </script>

  <script>
function cerrarSesion() {
  google.script.run
    .withSuccessHandler(function () {
      // Redirige a la URL pública del web app
          window.location.href = '?page=login';
    })
    .cerrarSesion();
}

</script>

</body>

</html>
